name: Build and Release DMG

on:
  push:
    tags:
      - 'v0.*.*'
      - 'v[1-9].*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.1'
    
    - name: Resolve Swift Package Dependencies
      run: |
        xcodebuild -resolvePackageDependencies \
          -scheme iDither
    
    - name: Build app
      run: |
        xcodebuild -scheme iDither \
          -configuration Release \
          -derivedDataPath ./build \
          -destination 'platform=macOS' \
          clean build
    
    - name: Create App Bundle
      run: |
        echo "üì¶ Cr√©ation du bundle .app..."
        
        # Chemins des √©l√©ments compil√©s
        EXECUTABLE="./build/Build/Products/Release/iDither"
        RESOURCES_BUNDLE="./build/Build/Products/Release/iDither_iDither.bundle"
        
        # V√©rification de l'ex√©cutable
        if [ ! -f "$EXECUTABLE" ]; then
          echo "‚ùå Ex√©cutable non trouv√© : $EXECUTABLE"
          exit 1
        fi
        
        echo "‚úÖ Ex√©cutable trouv√© ($(du -h "$EXECUTABLE" | cut -f1))"
        
        # Cr√©e la structure du bundle .app
        APP_DIR="./iDither.app"
        mkdir -p "$APP_DIR/Contents/MacOS"
        mkdir -p "$APP_DIR/Contents/Resources"
        
        # Copie l'ex√©cutable
        cp "$EXECUTABLE" "$APP_DIR/Contents/MacOS/iDither"
        chmod +x "$APP_DIR/Contents/MacOS/iDither"
        echo "‚úÖ Ex√©cutable copi√© dans le bundle"
        
        # Copie le bundle de ressources (shaders Metal)
        if [ -d "$RESOURCES_BUNDLE" ]; then
          cp -R "$RESOURCES_BUNDLE" "$APP_DIR/Contents/Resources/"
          echo "‚úÖ Bundle de ressources copi√© (shaders Metal inclus)"
        else
          echo "‚ö†Ô∏è  Bundle de ressources non trouv√© (l'app pourrait ne pas fonctionner)"
        fi
        
        # Cr√©e Info.plist
        cat > "$APP_DIR/Contents/Info.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>iDither</string>
            <key>CFBundleIdentifier</key>
            <string>com.ewengadonnaud.iDither</string>
            <key>CFBundleName</key>
            <string>iDither</string>
            <key>CFBundleDisplayName</key>
            <string>iDither</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSMinimumSystemVersion</key>
            <string>14.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>LSApplicationCategoryType</key>
            <string>public.app-category.graphics-design</string>
        </dict>
        </plist>
        EOF
        
        echo "‚úÖ Info.plist cr√©√©"
        echo ""
        echo "üì¶ Structure du bundle .app :"
        ls -lh "$APP_DIR/Contents/MacOS/"
        ls -lh "$APP_DIR/Contents/Resources/" 2>/dev/null || echo "(pas de ressources visibles)"
    
    - name: Create DMG
      run: |
        APP_PATH="./iDither.app"
        
        if [ ! -d "$APP_PATH" ]; then
          echo "‚ùå Bundle .app non trouv√©"
          exit 1
        fi
        
        echo "‚úÖ Cr√©ation du DMG depuis : $APP_PATH"
        
        # Cr√©e un dossier temporaire pour le DMG
        mkdir -p dmg_content
        cp -R "$APP_PATH" dmg_content/
        
        # Ajoute un lien symbolique vers /Applications
        ln -s /Applications dmg_content/Applications
        
        # Cr√©e le DMG
        DMG_NAME="iDither-${{ github.ref_name }}.dmg"
        hdiutil create -volname "iDither" \
          -srcfolder dmg_content \
          -ov -format UDZO \
          "$DMG_NAME"
        
        echo "‚úÖ DMG cr√©√© :"
        ls -lh "$DMG_NAME"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: iDither-*.dmg
        draft: false
        prerelease: ${{ startsWith(github.ref, 'refs/tags/v0.') }}
        body: |
          ## iDither ${{ github.ref_name }}
          
          Application macOS native de dithering en temps r√©el, propuls√©e par Metal et SwiftUI.
          
          ### Installation
          1. T√©l√©chargez le fichier `.dmg`
          2. Ouvrez-le et glissez **iDither** vers **Applications**
          3. Au premier lancement : **clic droit** ‚Üí **Ouvrir** (contournement de la s√©curit√© Gatekeeper)
          
          ### Algorithmes disponibles
          - Matrices ordonn√©es (Bayer 2x2, 4x4, 8x8 / Cluster 4x4, 8x8)
          - Blue Noise approxim√©
          - Diffusion d'erreur Floyd-Steinberg
          - Mode Chaos/FX avec distorsions avanc√©es
          
          ---
          **Compatibilit√© :** macOS 14.0+ (Sonoma)  
          **Architecture :** Apple Silicon (M1/M2/M3/M4) & Intel  
          **Build automatique** via GitHub Actions
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}