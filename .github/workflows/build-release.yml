name: Build and Release DMG

on:
  push:
    tags:
      - 'v0.*.*'
      - 'v[1-9].*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.1'
    
    - name: Resolve Swift Package Dependencies
      run: |
        xcodebuild -resolvePackageDependencies \
          -scheme iDither
    
    - name: Build app
      run: |
        xcodebuild -scheme iDither \
          -configuration Release \
          -derivedDataPath ./build \
          -destination 'platform=macOS' \
          clean build
    
    - name: Debug - List all build outputs
      run: |
        echo "ğŸ” === DIAGNOSTIC COMPLET ==="
        echo ""
        echo "ğŸ“ Contenu de ./build/Build/Products/Release/ :"
        ls -laR ./build/Build/Products/Release/
        echo ""
        echo "ğŸ” Recherche de tous les .app :"
        find ./build -name "*.app" -type d
        echo ""
        echo "ğŸ” Recherche de tous les exÃ©cutables :"
        find ./build -type f -perm +111 -name "iDither"
        echo ""
        echo "ğŸ” Recherche de tous les fichiers :"
        find ./build/Build/Products/Release/ -type f